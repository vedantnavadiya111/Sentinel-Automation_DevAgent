services:
  n8n:
    image: n8nio/n8n:latest
    container_name: sentinel_n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      # Optional basic auth (recommended if you expose the port)
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-false}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-}
      # Optional: reduce external calls / telemetry
      - N8N_DIAGNOSTICS_ENABLED=false
      # Used by the Groq HTTP node in the sample workflow
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.3-70b-versatile}
    volumes:
      - n8n_data:/home/node/.n8n
      - workspace_volume:/workspace
      - workspace_volume:/data/projects
    depends_on:
      - qdrant
      - sentinel_mcp
      - sentinel_memory
    networks:
      - sentinel_net

  qdrant:
    image: qdrant/qdrant:latest
    container_name: sentinel_qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - sentinel_net

  sentinel_mcp:
    build:
      context: ./sentinel_mcp
    container_name: sentinel_mcp
    restart: unless-stopped
    environment:
      - WORKSPACE_ROOT=/workspace
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8001
      - MCP_TRANSPORT=streamable-http
    volumes:
      - workspace_volume:/workspace
    ports:
      - "8001:8001"
    networks:
      - sentinel_net

  sentinel_memory:
    build:
      context: ./sentinel_memory
    container_name: sentinel_memory
    restart: unless-stopped
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - MEM0_COLLECTION=${MEM0_COLLECTION:-sentinel_memories}
      - HF_EMBED_MODEL=${HF_EMBED_MODEL:-multi-qa-MiniLM-L6-cos-v1}
      - HF_EMBED_DIMS=${HF_EMBED_DIMS:-384}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.3-70b-versatile}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8002
      - HF_HOME=/root/.cache/huggingface
      - TRANSFORMERS_CACHE=/root/.cache/huggingface
    depends_on:
      - qdrant
    ports:
      - "8002:8002"
    volumes:
      - hf_cache:/root/.cache/huggingface
    networks:
      - sentinel_net

volumes:
  n8n_data:
  qdrant_data:
  hf_cache:
  # A named volume that is actually a bind mount to a host folder.
  # Set WORKSPACE_PATH in .env to point at the project you want Sentinel to edit.
  workspace_volume:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WORKSPACE_PATH:-./workspace}

networks:
  sentinel_net:
    driver: bridge
